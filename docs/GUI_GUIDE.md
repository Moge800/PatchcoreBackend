# GUI操作ガイド

## PatchCore モデル操作GUI

### 起動方法

```bash
python model_create_gui.py
```

---

## 主な機能

### 1. モデル選択

ドロップダウンメニューから操作対象のモデルを選択します。

- **確定ボタン**: 選択したモデルを有効化
- モデル選択後は、そのモデルの設定ファイルが使用されます

---

### 2. settings編集

モデルの設定ファイル（`settings.py`）を開きます。

**編集可能な設定:**
- `IMAGE_SIZE`: 入力画像サイズ
- `AFFINE_POINTS`: 射影変換座標
- `Z_SCORE_THRESHOLD`: 異常検知しきい値
- `FEATURE_DEPTH`: 特徴抽出の深さ
- `USE_GPU`: GPU使用設定
- その他のパラメータ

**注意:** 設定変更後は「確定」ボタンを押して反映してください。

---

### 3. 設定検証 ⭐ NEW

設定ファイルの妥当性をチェックします。

**検証項目:**
- ✅ 必須設定の存在確認
- ✅ データ型の検証
- ✅ 値の範囲チェック
- ✅ 依存関係の確認

**使用タイミング:**
- 設定ファイル編集後
- 学習・推論実行前（自動実行）

**実行方法:**
1. 「設定検証」ボタンをクリック
2. 結果がログエリアに表示されます
3. エラーがある場合はダイアログで通知

**自動検証:**
学習・推論実行時に自動的に設定が検証されます。問題がある場合は確認ダイアログが表示されます。

---

### 4. アフィン座標取得

射影変換用の4点座標を画像から取得します。

**手順:**
1. 「アフィン座標取得」ボタンをクリック
2. 画像選択ダイアログが表示されます
3. マウスで4点をクリックして選択
4. 座標が自動的に設定ファイルに保存されます

**座標の順序:**
1. 左上
2. 右上
3. 右下
4. 左下

---

### 5. 学習実行

正常画像から異常検知モデルを学習します。

**前提条件:**
- `datasets/{model_name}/normal/` に正常画像が配置されている
- 設定ファイルが正しく設定されている

**実行手順:**
1. 「学習実行」ボタンをクリック
2. 自動的に設定検証が実行されます
3. 問題がなければ学習が開始されます
4. ログエリアに進捗が表示されます

**出力:**
- `models/{model_name}/model.pt`: 学習済みモデル
- `models/{model_name}/memory_bank_compressed.pkl`: 特徴量データベース
- `models/{model_name}/pca.pkl`: PCA変換モデル
- `models/{model_name}/pixel_stats.pkl`: ピクセル統計

**所要時間:**
- 画像100枚: 約30秒～1分
- 画像1000枚: 約5～10分

---

### 6. テスト推論実行

学習済みモデルでテスト画像を推論します。

**前提条件:**
- モデルが学習済み
- `settings/models/{model_name}/test_image/` にテスト画像が配置されている

**実行手順:**
1. 「テスト推論実行」ボタンをクリック
2. 自動的に設定検証が実行されます
3. 問題がなければ推論が開始されます
4. 結果画像がウィンドウに表示されます

**出力:**
- 画面表示: 元画像とヒートマップの並列表示
- ログ: 判定結果（OK/NG）と統計情報

---

## ログエリア

画面下部のログエリアに以下の情報が表示されます:

- 📝 実行中のスクリプト
- 📊 処理進捗
- ✅ 成功メッセージ
- ❌ エラーメッセージ
- 📈 統計情報

**ログの保存:**
GUIを閉じると、ログが自動的に `settings/gui_log/{timestamp}.log` に保存されます。

---

## トラブルシューティング

### ボタンが無効化されている

**原因:** モデルが確定されていない

**解決策:**
1. ドロップダウンからモデルを選択
2. 「確定」ボタンをクリック

### 設定検証エラー

**よくあるエラー:**

1. **「AFFINE_POINTS は4点のリストである必要があります」**
   - アフィン座標が正しく設定されていません
   - 「アフィン座標取得」で再設定してください

2. **「Z_SCORE_THRESHOLD は正の数値である必要があります」**
   - しきい値が0以下または数値以外です
   - settings.py で正の数値に修正してください

3. **「IMAGE_SIZE は (width, height) のタプルである必要があります」**
   - 画像サイズの形式が間違っています
   - 例: `IMAGE_SIZE = (224, 224)`

### 学習が失敗する

**確認事項:**
1. `datasets/{model_name}/normal/` に画像があるか
2. 画像フォーマットがPNGか
3. 設定検証でエラーがないか
4. ディスク容量は十分か

### 推論が失敗する

**確認事項:**
1. モデルが学習済みか（`models/{model_name}/model.pt` が存在するか）
2. テスト画像が配置されているか
3. 画像サイズが学習時と同じか

---

## キーボードショートカット

現在、キーボードショートカットはサポートされていません。

---

## パフォーマンスヒント

1. **学習の高速化:**
   - GPU環境の使用（設定: `USE_GPU = True`）
   - データ拡張の無効化（`ENABLE_AUGMENT = False`）
   - 特徴深度の削減（`FEATURE_DEPTH = 1`）

2. **精度の向上:**
   - データ拡張の有効化
   - 特徴深度の増加（`FEATURE_DEPTH = 2 or 3`）
   - しきい値の調整

3. **メモリ使用量の削減:**
   - 画像サイズの縮小（`IMAGE_SIZE = (112, 112)`）
   - 圧縮形式の使用（`SAVE_FORMAT = "compressed"`）

---

## 更新履歴

### v1.1.0 (2025-10-04)
- ✨ **設定検証機能を追加**
  - 手動検証ボタン
  - 学習・推論前の自動検証
  - エラーの詳細表示

### v1.0.0
- 初期リリース
- モデル選択機能
- 学習・推論実行機能
- ログ表示機能
